---
title: 消息中间件
date: 2025-04-25 16:48:14
tags: ["消息队列"]
categories:  ["java","消息队列"] 
---

消息中间件是接受数据，接受请求，存储数据，发送数据等功能的技术服务
中间件是连接， 消息中间件还要完成数据的传递
1：利用可靠的消息传递机制进行系统和系统直接的通讯  
2：通过提供消息传递和消息的排队机制，它可以在分布式系统环境下扩展进程间的通讯。



核心组成部分包括： 
1. 消息的协议
2. 消息的持久化存储
3. 消息的分发策略
4. 消息的高可用，高可靠
5. 消息的容错机制

常见的消息中间件：
rabbitmq ， kafka， rocketmq


# 消息的协议
消息中间件使用的协议有：AMQP，kafka 等
都是在tcp/ip协议之上进一步封装的

为什么不使用http协议呢
1. http协议的请求头与请求体太过复杂，还有 状态码，cookie等附加功能， 我们只希望完成消息的发送，存储，转发的功能，http显得太过冗余，性能不够高，为了追求高性能，不使用
2. http是短链接，如果在请求中中断了，请求就会直接丢失，不会持久化。而消息是一定要持久化的，如果消息丢失，后果比较严重的。所以不能使用http

AMQP协议 的实现有rabbitmq， 使用erlang开发
支持分布式事务，支持持久化

kafka 是基于tcp/ip的二进制协议，非常快，
支持持久化，不支持事务



# 消息的持久化
是指： 将消息存入磁盘，
而不是存在内存中随服务器重启断开而消失，使数据能够永久保存。

常见的存储策略：
- 文件存储： rabbitmq， kafka， rocketmq
- 数据库： activemq

存储到数据库会引发很多问题，几乎不采用


# 分发策略
在消息队列中有三个角色：
1. 生产者
2. 存储消息
3. 消费者


- 当生产者产生消息后，消费者如何获取呢
	获取数据类比git ，其实就是pull 与push两种
	消息队列采用的主要是 push，也就是有存储消息的区域主动推送数据给消费者

- 我们的系统中，为了保证性能，一般消费者都会不止一个，那么具体推送给谁呢 
	这就涉及到了分发策略


分发策略有以下几种：
1. 发布订阅
2. 轮询分发
3. 公平分发
4. 重发 当消息发送失败时，会触发重发，将消息给另一个消费者
5. 消息拉取

rabbitmq都支持 ，kafka不支持重发


# 消息的高可用与高可靠
高可用是指在任意时间与场景都要保证服务可执行
出现了故障也要可以正确执行

实现高可用的方案： 使用集群

集群的集中策略：
1. 主从共享
数据全部存储到一块区域， 主节点负责数据的写入， 从节点负责数据的读取
一般不会采用这种， 一旦这块数据区域丢失，数据就没了

2. 主从同步 类似redis 
主节点负责写，从节点负责读取， 主节点的数据会复制到从节点保证数据一致性
会占用带宽

3. 多主多从
与主从同步相似，任意节点可以写入

4. 多主集群部署转发
主从之间同步**元数据**信息， 当请求到达从节点，就开始查询，没有就到从节点的元数据中进行查询，如果有就返回，如果没有就携带请求信息发送一个请求到其他节点，进行查询


5. 小规模与负载均衡


--- 
高可靠是指当服务器发生宕机崩溃等故障后，可以迅速恢复，可以不影响线上的业务的正常运行

持久化可以保证高可靠